## 演習

### アプリケーションの起動

以下のコマンドをターミナルで実行してみましょう。

```bash
docker-compose up
```

### アプリケーションの概要

このアプリケーションでは、nginxの設定であえてHTTPヘッダインジェクションを可能にする設定を加えることで、
特定のURL `http://127.0.0.1/v1/*.json` (`*`は任意の文字列)に対して、`X-Action: (任意の文字列)`というHTTPヘッダを返すようにしています。
この任意の文字列の中で改行検査をしていないため、HTTPヘッダインジェクションを起こすことができます。

### 攻撃

攻撃を行う前に、以下の準備を行ってください。

* ブラウザに保存されたクッキーのうち、ホスト `127.0.0.1` の分をクリアしておく。

具体的な攻撃の手順は以下の通りです。

1. `http://127.0.0.1/v1/test%0d%0aSet-Cookie:%20TESTCOOKIE1=yes.json"` をブラウザのURLに指定し、アクセスする。
2. 実行された結果、"OK"という文字列のみが表示される。
3. ブラウザで、ホスト`127.0.0.1`に対するCookieの中身を見ると、クッキー`TESTCOOKIE1`に対し`yes`という値が設定されている。 
4. `http://127.0.0.1/v1/test%0d%0aSet-Cookie:%20TESTCOOKIE2=testvalue.json"` をブラウザのURLに指定し、アクセスする。
5. 実行された結果、"OK"という文字列のみが表示される。
6. ブラウザで、ホスト`127.0.0.1`に対するCookieの中身を見ると、クッキー`TESTCOOKIE2`に対し`testvalue`という値が設定されている。 

### 攻撃の対策

この攻撃は、nginx.confのこの部分によって引き起こされたものですので、以下の該当部分を削除すれば攻撃の可能性はなくなります。

```
        location ~ /v1/((?<action>[^.]*)\.json)?$ {
            # inject received content
            add_header X-Action $action;
            return 200 "OK";
        }
```

この設定の具体的な問題としては

* 変数 `$action` を設定する正規表現で改行コードの検査をしていない
* `add_header` にて改行コードの検査をしていない

ことが挙げられます。
